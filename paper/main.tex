\documentclass{article}
\usepackage{mathpartir}
\usepackage{amsmath}
\usepackage{float}
\usepackage{amsthm}

\DeclareMathOperator{\dom}{dom}
\begin{document}

\newcommand{\imm}{\textrm{imm}}
\newcommand{\mut}{\textrm{mut}}
\newcommand{\zah}{\textrm{int}}
\newcommand{\pay}{\textrm{pay}}
\newcommand{\unroll}{\textrm{unroll}}
\newcommand{\roll}{\textrm{roll}}
\newcommand{\void}{\textrm{void}}
\newcommand{\slot}{\textrm{slot}}
\newcommand{\uninit}{\textrm{uninit}}
\newcommand{\hole}{\textrm{hole}}
\newcommand{\init}{\textrm{init}}

\newcommand{\Own}[1]{\sim {#1}}
\newcommand{\Ref}[3]{\&\ {#1}\ {#2}\ {#3}}
\newcommand{\Var}[2]{\langle {#1} \rangle_{#2}}
\newcommand{\Rec}[2]{[ {#1} ]_{#2}}
\newcommand{\Fix}[2]{\mu {#1}.{#2}}

\newcommand{\Base}{\cdot}
\newcommand{\Deref}[1]{*\ {#1}}
\newcommand{\Proj}[3]{{#1}\cdot_{#2} {#3}}
\newcommand{\Pay}[1]{\pay\ {#1}}
\newcommand{\Unroll}[2]{\unroll\ [{#1}]\ {#2}}

\newcommand{\OwnVal}[2]{\Own{{#1}\ {#2}}}
\newcommand{\Slot}[1]{\slot\ {#1}}
\newcommand{\VarVal}[3]{\langle {#1} : {#2} \rangle_{#3}}
\newcommand{\Roll}[2]{\roll\ [{#1}]\ {#2}}

\newcommand{\RefVal}[2]{\&\ {#1}\ {#2}}
\newcommand{\Hole}[1]{\hole\ {#1}}

\newcommand{\Subst}[3]{[{#1} \mapsto {#2}]{#3}}

\newcommand{\Type}[3]{{#1} \vdash {#2} : {#3}}
\newcommand{\PType}[4]{\Type{{#1}}{{#2}\ {#3}}{{#4}}}
\newcommand{\RTType}[4]{\Type{{#1} ;{#2}}{{#3}}{{#4}}}
\newcommand{\ARType}[5]{\RTType{{#1}}{{#2}}{{#3}\ {#4}}{{#5}}}
\newcommand{\Read}[4]{\textsc{read}({#1},{#2},{#3},{#4})}
\newcommand{\HWF}[3]{\vdash {#1} : {#2} ; {#3}}
\newcommand{\SWF}[3]{{#1}; {#2} \vdash {#3}}
\newcommand{\YWF}[2]{\vdash {#1} : {#2}}
\newcommand{\Shallow}[4]{\textsc{shallow}({#1},{#2},{#3},{#4})}
\newcommand{\Eval}[3]{{#1} \vdash {#2} \rightarrow {#3}}
\newcommand{\PEval}[6]{\Eval{{#1};{#2}}{{#3}\ {#4}}{{#5}\ {#6}}}

\section{Syntax}

TODO describe Lifetime in more detail (values vs variables, the relation etc).

\begin{figure}[H]
  $\ell \in $ Lifetime

  $x \in $ Variable

  $\alpha \in $ Allocation

  $z \in $ Integer

  $X \in $ Type Variable

  $i,n \in $ Natural
  \caption{Sets}
\end{figure}

\begin{figure}[H]
  Qual $q ::= \imm{}\ |\ \mut{}$

  Type $\tau ::= \zah{}\ |\ \Own{\tau}\ |\ \Ref{\ell}{q}{\tau}\ 
	      |\ \Var{\tau_i}{n}\ |\ \Rec{\tau_i}{n}\ |\ \Fix{X}{\tau}\ |\ X$

  Route $r ::= \Base\ |\ \Proj{r}{n}{i}\ |\ \Pay{r}\ |\ \Unroll{\tau}{r} $

  Slot $s ::= \void\ |\ z\ |\ \OwnVal{\alpha}{r}\ |\ \Ref{q}{\alpha}{r} $

  Layout $l ::= \Slot{s}\ |\ \VarVal{s}{l}{n}\ |\ \Rec{l_i}{n}\ |\ \Roll{\tau}{l} $

  Path $p ::= \Base\ |\ \Deref{p}\ |\ \Proj{p}{n}{i}\ |\ \Unroll{\tau}{p} $

  Hole $h ::= \uninit\ |\ \zah\ |\ \RefVal{q}{\tau}\ |\ \Own{\sigma}\ |\ \Var{\tau_i}{n} $

  Shape $\sigma ::= \Hole{h}\ |\ \Rec{\sigma_i}{n}\ |\ \Roll{\tau}{\sigma} $

  \caption{Syntax}
\end{figure}

\begin{figure}[H]
  $H : $ Allocation $\to$ Layout

  $\Gamma : $ Variable $\to$ Type

  $V : $ Variable $\to$ Allocation

  $\Sigma : $ Allocation $\to$ Type

  $\Delta \subseteq $ Type Variable

  $\Psi : $ Allocation $\times$ Route $\to$ Natural

  $\Upsilon : $ Variable $\to$ Shape
  \caption{Environments}
\end{figure}

\section{Runtime Typing}

\begin{figure}[H]
  \begin{mathpar}
    \inferrule[RT-BASE]
      {\Sigma (\alpha) = \tau}
      {\ARType{\Sigma}{\Psi}{\alpha}{\Base}{\tau}}

    \inferrule[RT-PROJ]
      {\ARType{\Sigma}{\Psi}{\alpha}{r}{\Rec{\tau_i}{n}}}
      {\ARType{\Sigma}{\Psi}{\alpha}{\Proj{r}{n}{i}}{\tau_i}}

    \inferrule[RT-PAY]
      {\Psi(\alpha, r) = i \\ \ARType{\Sigma}{\Psi}{\alpha}{r}{\Var{\tau_i}{n}}}
      {\ARType{\Sigma}{\Psi}{\alpha}{\Pay{r}}{\tau_i}}

    \inferrule[RT-UNROLL]
      {\tau = \Fix{X}{\tau'} \\ \ARType{\Sigma}{\Psi}{\alpha}{r}{\tau}}
      {\ARType{\Sigma}{\Psi}{\alpha}{\Unroll{\tau}{r}}{\Subst{X}{\tau}{\tau'}}}
  \end{mathpar}
  \caption{Route Typing}
\end{figure}

\begin{figure}[H]
  \begin{mathpar}
    \infer[ST-VOIDINT]
      { }
      {\RTType{\Sigma}{\Psi}{\void}{\zah}}

    \infer[ST-VOIDOWN]
      { }
      {\RTType{\Sigma}{\Psi}{\void}{\Own{\tau}}}

    \infer[ST-VOIDREF]
      { }
      {\RTType{\Sigma}{\Psi}{\void}{\Ref{\ell}{q}{\tau}}}

    \infer[ST-INT]
      { }
      {\RTType{\Sigma}{\Psi}{z}{\zah}}

    \infer[ST-OWN]
      {\ARType{\Sigma}{\Psi}{\alpha}{r}{\tau}}
      {\RTType{\Sigma}{\Psi}{\OwnVal{\alpha}{r}}{\Own{\tau}}}

    \infer[ST-REF]
      {\ARType{\Sigma}{\Psi}{\alpha}{r}{\tau}}
      {\RTType{\Sigma}{\Psi}{\Ref{q}{\alpha}{r}}{\Ref{\ell}{q}{\tau}}}
  \end{mathpar}
  \caption{Slot Typing}
\end{figure}

\begin{figure}[H]
  \begin{mathpar}
    \infer[LT-SLOT]
      {\RTType{\Sigma}{\Psi}{s}{\tau}}
      {\RTType{\Sigma}{\Psi}{\Slot{s}}{\tau}}
    
    \infer[LT-VOIDVAR]
      { }
      {\RTType{\Sigma}{\Psi}{\VarVal{\void}{\Slot{\void}}{n}}{\Var{\tau_i}{n}}}

    \infer[LT-VAR]
      {\RTType{\Sigma}{\Psi}{l}{\tau_i}}
      {\RTType{\Sigma}{\Psi}{\VarVal{i}{l}{n}}{\Var{\tau_i}{n}}}

    \infer[LT-REC]
      {\forall i.\ \RTType{\Sigma}{\Psi}{l_i}{\tau_i}}
      {\RTType{\Sigma}{\Psi}{\Rec{l_i}{n}}{\Rec{\tau_i}{n}}}

    \infer[LT-ROLL]
      {\tau = \Fix{X}{\tau'} \\ \RTType{\Sigma}{\Psi}{l}{\Subst{X}{\tau}{\tau'}}}
      {\RTType{\Sigma}{\Psi}{\Roll{\tau}{l}}{\tau}}
  \end{mathpar}
  \caption{Layout Typing}
\end{figure}

\begin{figure}[H]
  \begin{mathpar}
    \mprset{flushleft}
    \infer
      {\dom(H) = \dom(\Sigma) \\\\
       \forall \alpha \in \dom(H).\ \RTType{\Sigma}{\Psi}{H(\alpha)}{\Sigma(\alpha)} \\\\
       \forall \alpha \in \dom(\Sigma).\ \Sigma(\alpha)\ \textrm{closed} \\\\
       \forall (\alpha, r) \in \dom(\Psi).\ \Read{H}{\alpha}{r}{\VarVal{\Psi(\alpha, r)}{l}{n}}
      }
      {\HWF{H}{\Sigma}{\Psi}} \\
    \infer
      {\forall x \in \dom{\Gamma}.\ \Gamma(x) = \Sigma(V(x))}
      {\SWF{\Gamma}{V}{\Sigma}}
  \end{mathpar}
  \caption{Heap Well-Formed}
\end{figure}

\section{Reading}

\begin{figure}[H]
  \begin{mathpar}
    \infer[RD-BASE]
      {H(\alpha) = l}
      {\Read{H}{\alpha}{\Base}{l}}

    \infer[RD-PROJ]
      {\Read{H}{\alpha}{r}{\Rec{l_i}{n}}}
      {\Read{H}{\alpha}{\Proj{r}{n}{i}}{l_i}}

    \infer[RD-PAY]
      {\Read{H}{\alpha}{r}{\VarVal{s}{l}{n}}}
      {\Read{H}{\alpha}{\Pay{r}}{l}}

    \infer[RD-UNROLL]
      {\Read{H}{\alpha}{r}{\Roll{\tau'}{l}}}
      {\Read{H}{\alpha}{\Unroll{\tau}{r}}{l}}

  \end{mathpar}
  \caption{Reading}
\end{figure}

\newtheorem{lem}{Lemma}

\begin{lem}[Read Uniqueness]
  $\Read{H}{\alpha}{r}{l}\ \land\ \Read{H}{\alpha}{r}{l'}\ \Rightarrow\ l = l'$.
\end{lem}

\begin{proof}
  Induction on the derivation of $\Read{H}{\alpha}{r}{l}$.

  \textsc{Case RD-BASE}:
    Then $r = \Base$ and $H(\alpha) = l$.

    By inversion via \textsc{RD-BASE} on $\Read{H}{\alpha}{\Base}{l'}$, $H(\alpha) = l'$.
    Ergo, $l = l'$.

  \textsc{Case RD-PROJ}:
    Then $r = \Proj{r'}{n}{i}$, $l = l_i$, and $\Read{H}{\alpha}{r'}{\Rec{l_i}{n}}$.

    By inversion via \textsc{RD-PROJ} on $\Read{H}{\alpha}{\Proj{r'}{n}{i}}{l'}$,
    $l' = l'_i$ and $\Read{H}{\alpha}{r'}{\Rec{l'_i}{n}}$.

    By induction, $\Rec{l_i}{n} = \Rec{l'_i}{n}$. Thus, $l_i = l'_i$.

  \textsc{Case RD-PAY}:
    Then $r = \Pay{r'}$ and $\Read{H}{\alpha}{r'}{\VarVal{s}{l}{n}}$.

    By inversion via \textsc{RD-PAY} on $\Read{H}{\alpha}{\Pay{r'}}{l'}$,
    $\Read{H}{\alpha}{r'}{\VarVal{s'}{l'}{n'}}$.

    By induction, $\VarVal{s}{l}{n} = \VarVal{s'}{l'}{n'}$. Ergo, $l = l'$.

  \textsc{Case RD-UNROLL}:
    Then $r = \Unroll{\tau}{r'}$ and $\Read{H}{\alpha}{r'}{\Roll{\tau'}{l}}$.

    By inversion via \textsc{RD-UNROLL} on $\Read{H}{\alpha}{\Unroll{\tau}{r'}}{l'}$,
    $\Read{H}{\alpha}{r'}{\Roll{\tau''}{l'}}$.

    By induction, $\Roll{\tau'}{l} = \Roll{\tau''}{l'}$. Thus, $l = l'$.
\end{proof}

\begin{lem}[Read Safety]
  $\HWF{H}{\Sigma}{\Psi}\ \land\ \ARType{\Sigma}{\Psi}{\alpha}{r}{\tau}\ \Rightarrow\ 
  \exists l. \Read{H}{\alpha}{r}{l} \land \RTType{\Sigma}{\Psi}{l}{\tau}$.
\end{lem}

\begin{proof}
  Induction on the derivation of $\ARType{\Sigma}{\Psi}{\alpha}{r}{\tau}$.
  
  \textsc{Case RT-BASE}:
    Then $r = \Base$ and $\Sigma(\alpha) = \tau$.

    We know $\dom(H) = \dom(\Sigma)$ from $\HWF{H}{\Sigma}{\Psi}$.
    Thus, $\exists l.\ H(\alpha) = l$.

    Then $\Read{H}{\alpha}{\Base}{H(\alpha)}$ by \textsc{RD-BASE}.

    We also know $\RTType{\Sigma}{\Psi}{H(\alpha)}{\Sigma(\alpha)}$ from $\HWF{H}{\Sigma}{\Psi}$.

  \textsc{Case RT-PROJ}:
    Then $r = \Proj{r'}{n}{i}$, $\tau = \tau_i$,
    and $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Rec{\tau_i}{n}}$.

    By induction on $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Rec{\tau_i}{n}}$,
    $\exists l.\ \Read{H}{\alpha}{r'}{l}\ \land\ \RTType{\Sigma}{\Psi}{l}{\Rec{\tau_i}{n}}$.

    By inversion via \textsc{LT-REC} on $\RTType{\Sigma}{\Psi}{l}{\Rec{\tau_i}{n}}$, 
    $l = \Rec{l_i}{n}$ and $\forall i.\ \RTType{\Sigma}{\Psi}{l_i}{\tau_i}$.

    By applying \textsc{RD-PROJ} to $\Read{H}{\alpha}{r'}{\Rec{l_i}{n}}$,
    we have $\Read{H}{\alpha}{\Proj{r'}{n}{i}}{l_i}$.

  \textsc{Case RT-PAY}:
    Then $r = \Pay{r'}$, $\tau = \tau_i$, $\Psi(\alpha, r')=i$,
    and $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Var{\tau_i}{n}}$.

    By induction on $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Var{\tau_i}{n}}$,
    $\exists l.\ \Read{H}{\alpha}{r'}{l}\ \land\ \RTType{\Sigma}{\Psi}{l}{\Var{\tau_i}{n}}$.

    From $\HWF{H}{\Sigma}{\Psi}$ and $\Psi(\alpha, r') = i$,
    we have $\Read{H}{\alpha}{r'}{\VarVal{i}{l'}{n'}}$.

    By Read Uniqueness, $l = \VarVal{i}{l'}{n}$.
    Note $n = n'$ due to $\RTType{\Sigma}{\Psi}{\VarVal{i}{l'}{n'}}{\Var{\tau_i}{n}}$.

    By inversion via \textsc{LT-VAR} on $\RTType{\Sigma}{\Psi}{\VarVal{i}{l'}{n}}{\Var{\tau_i}{n}}$,
    we have $\RTType{\Sigma}{\Psi}{l'}{\tau_i}$.

    By applying \textsc{RD-PAY} to $\Read{H}{\alpha}{r'}{\VarVal{i}{l'}{n}}$,
    we have $\Read{H}{\alpha}{\Pay{r'}}{l'}$.

  \textsc{Case RT-UNROLL}:
    Then $r = \Unroll{\Fix{X}{\tau'}}{r'}$, $\tau = \Subst{X}{\Fix{X}{\tau'}}{\tau'}$,
    and $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Fix{X}{\tau'}}$.

    By induction on $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Fix{X}{\tau'}}$,
    we have $\exists l.\ \Read{H}{\alpha}{r'}{l}\ \land\ \RTType{\Sigma}{\Psi}{l}{\Fix{X}{\tau'}}$.

    By inversion via \textsc{LT-ROLL} on $\RTType{\Sigma}{\Psi}{l}{\Fix{X}{\tau'}}$,
    we have $l = \Roll{\Fix{X}{\tau'}}{l'}$ and
    $\RTType{\Sigma}{\Psi}{l'}{\Subst{X}{\Fix{X}{\tau'}}{\tau'}}$.

    By applying \textsc{RD-UNROLL} to $\Read{H}{\alpha}{r'}{\Roll{\Fix{X}{\tau'}}{l'}}$,
    we have\\ $\Read{H}{\alpha}{\Unroll{\Fix{X}{\tau'}}{r'}}{l'}$.
\end{proof}

\section{Initialization Information}

\subsection{Typing for Initialization Information}

\begin{figure}[H]
  \begin{mathpar}
    \infer[HT-UNINT]
      { }
      {\Type{\Upsilon}{\uninit}{\zah}}

    \infer[HT-UNREF]
      { }
      {\Type{\Upsilon}{\uninit}{\Ref{\ell}{q}{\tau}}}

    \infer[HT-UNOWN]
      { }
      {\Type{\Upsilon}{\uninit}{\Own{\tau}}}

    \infer[HT-UNVAR]
      { }
      {\Type{\Upsilon}{\uninit}{\Var{\tau_i}{n}}}

    \infer[HT-INT]
      { }
      {\Type{\Upsilon}{\zah}{\zah}}

    \infer[HT-REF]
      { }
      {\Type{\Upsilon}{\RefVal{q}{\tau}}{\Ref{\ell}{q}{\tau}}}

    \infer[HT-OWN]
      {\Type{\Upsilon}{\sigma}{\tau}}
      {\Type{\Upsilon}{\Own{\sigma}}{\Own{\tau}}}

    \infer[HT-VAR]
      { }
      {\Type{\Upsilon}{\Var{\tau_i}{n}}{\Var{\tau_i}{n}}}
  \end{mathpar}
  \caption{Hole Typing}
\end{figure}

\begin{figure}[H]
  \begin{mathpar}
    \infer[SH-HOLE]
      {\Type{\Upsilon}{h}{\tau}}
      {\Type{\Upsilon}{\Hole{h}}{\tau}}

    \infer[SH-REC]
      {\forall i.\ \Type{\Upsilon}{\sigma_i}{\tau_i}}
      {\Type{\Upsilon}{\Rec{\sigma_i}{n}}{\Rec{\tau_i}{n}}}

    \infer[SH-ROLL]
      {\tau = \Fix{X}{\tau'} \\ \Type{\Upsilon}{\sigma}{\Subst{X}{\tau}{\tau'}}}
      {\Type{\Upsilon}{\Roll{\tau}{\sigma}}{\tau}}
  \end{mathpar}
  \caption{Shape Typing}
\end{figure}

\subsection{Initialization Coherence}

\begin{figure}[H]
  \begin{mathpar}
    \infer[LS-VOID]
      { }
      {\Type{H}{\Slot{\void}}{\Hole{\uninit}}}

    \infer[LS-INT]
      { }
      {\Type{H}{\Slot{z}}{\Hole{\zah}}}

    \infer[LS-REF]
      {\Read{H}{\alpha}{r}{l} \\ TODO ?init(H,l)? }
      {\Type{H}{\Slot{\Ref{q}{\alpha}{r}}}{\Hole{\RefVal{q}{\tau}}}}

    \infer[LS-OWN]
      {\Read{H}{\alpha}{r}{l} \\ \Type{H}{l}{\sigma}}
      {\Type{H}{\Slot{\OwnVal{\alpha}{r}}}{\Hole{\Own{\sigma}}}}

    \infer[LS-VOIDVAR]
      { }
      {\Type{H}{\VarVal{\void}{\Slot{\void}}{n}}{\Hole{\uninit}}}

    \infer[LS-UNVAR]
      {TODO ?droppable(l)?}
      {\Type{H}{\VarVal{i}{l}{n}}{\Hole{\uninit}}}

    \infer[LS-VAR]
      {TODO ?init(H,l)?}
      {\Type{H}{\VarVal{i}{l}{n}}{\Hole{\Var{\tau_i}{n}}}}

    \infer[LS-REC]
      {\forall i.\ \Type{H}{l_i}{\sigma_i}}
      {\Type{H}{\Rec{l_i}{n}}{\Rec{\sigma_i}{n}}}

    \infer[LS-ROLL]
      {\Type{H}{l}{\sigma}}
      {\Type{H}{\Roll{\tau}{l}}{\Roll{\tau}{\sigma}}}

  \end{mathpar}
  \caption{Layout Shaping}
\end{figure}

\begin{figure}[H]
  \begin{mathpar}
    \mprset{flushleft}
    \infer
      {\dom(\Gamma) = \dom(\Upsilon) \\\\
       \forall x \in \dom(\Gamma).\ \Gamma(x)\ \textrm{closed} \\\\
       \forall x \in \dom(\Gamma).\ \Type{\Upsilon}{\Upsilon(x)}{\Gamma(x)}
      }
      {\YWF{\Upsilon}{\Gamma}}

    \infer
      {\dom(V) = \dom(\Upsilon) \\\\
       \forall x \in \dom(V).\ \Type{H}{H(V(x))}{\Upsilon(x)}
      }
      {\Type{V}{H}{\Upsilon}}
  \end{mathpar}
  \caption{Initialization Information Well Formed}
\end{figure}

\subsection{Shallow Initialization / Shape Reading}

\begin{figure}[H]
  \mprset{flushleft}
  \infer {
    \init(\zah) = \Hole{\zah} \\\\
    \init(\Own{\tau}) = \Hole{\Own{\init(\tau)}} \\\\
    \init(\Ref{\ell}{q}{\tau}) = \Hole{\RefVal{q}{\tau}} \\\\
    \init(\Var{\tau_i}{n}) = \Hole{\Var{\tau_i}{n}} \\\\
    \init(\Rec{\tau_i}{n}) = \Rec{\init(\tau_i)}{n} \\\\
    \init(\Fix{X}{\tau}) = \Roll{\Fix{X}{\tau}}{\init(\Subst{X}{\Fix{X}{\tau}}{\tau})}
  }{}
  \caption{Initialized Shape of Closed Types}
\end{figure}

\begin{figure}[H]
  \begin{mathpar}
    \infer[SI-BASE]
      {\Upsilon(x) = \sigma}
      {\Shallow{\Upsilon}{x}{\Base}{\sigma}}

    \infer[SI-PROJ]
      {\Shallow{\Upsilon}{x}{p}{\Rec{\sigma_i}{n}}}
      {\Shallow{\Upsilon}{x}{\Proj{p}{n}{i}}{\sigma_i}}

    \infer[SI-UNROLL]
      {\Shallow{\Upsilon}{x}{p}{\Roll{\tau'}{\sigma}}}
      {\Shallow{\Upsilon}{x}{\Unroll{\tau}{p}}{\sigma}}

    \infer[SI-DEOWN]
      {\Shallow{\Upsilon}{x}{p}{\Hole{\Own{\sigma}}}}
      {\Shallow{\Upsilon}{x}{\Deref{p}}{\sigma}}

    \infer[SI-DEREF]
      {\Shallow{\Upsilon}{x}{p}{\Hole{\RefVal{q}{\tau}}}}
      {\Shallow{\Upsilon}{x}{\Deref{p}}{\sigma}}
  \end{mathpar}
  \caption{Shallowly Initialized / Read Shape}
\end{figure}

\section{Paths}

\begin{figure}[H]
  \begin{mathpar}
    \infer[PE-BASE]
      {V(x) = \alpha}
      {\PEval{V}{H}{x}{\Base}{\alpha}{\Base}}

    \infer[PE-PROJ]
      {\PEval{V}{H}{x}{p}{\alpha}{r}}
      {\PEval{V}{H}{x}{\Proj{p}{n}{i}}{\alpha}{\Proj{r}{n}{i}}}

    \infer[PE-DEOWN]
      {\PEval{V}{H}{x}{p}{\alpha}{r} \\ 
       \Read{H}{\alpha}{r}{\Slot{\OwnVal{\alpha'}{r'}}}}
      {\PEval{V}{H}{x}{\Deref{p}}{\alpha'}{r'}}

    \infer[PE-DEREF]
      {\PEval{V}{H}{x}{p}{\alpha}{r} \\ 
      \Read{H}{\alpha}{r}{\Slot{\Ref{q}{\alpha'}{r'}}}}
      {\PEval{V}{H}{x}{\Deref{p}}{\alpha'}{r'}}

    \infer[PE-UNROLL]
      {\PEval{V}{H}{x}{p}{\alpha}{r}}
      {\PEval{V}{H}{x}{\Unroll{\tau}{p}}{\alpha}{\Unroll{\tau}{r}}}
  \end{mathpar}
  \caption{Path Evalutation}
\end{figure}

\begin{figure}[H]
  \begin{mathpar}
    \infer[PT-BASE]
      {\Gamma(x)=\tau}
      {\PType{\Gamma}{x}{\Base}{\tau}}

    \infer[PT-DEOWN]
      {\PType{\Gamma}{x}{p}{\Own{\tau}}}
      {\PType{\Gamma}{x}{\Deref{p}}{\tau}}

    \infer[PT-DEREF]
      {\PType{\Gamma}{x}{p}{\Ref{\ell}{q}{\tau}}}
      {\PType{\Gamma}{x}{\Deref{p}}{\tau}}

    \infer[PT-PROJ]
      {\PType{\Gamma}{x}{p}{\Rec{\tau_i}{n}}}
      {\PType{\Gamma}{x}{\Proj{p}{n}{i}}{\tau_i}}

    \infer[PT-UNROLL]
      {\tau=\Fix{X}{\tau'} \\ \PType{\Gamma}{x}{p}{\tau}}
      {\PType{\Gamma}{x}{\Unroll{\tau}{p}}{\Subst{X}{\tau}{\tau'}}}
  \end{mathpar}
  \caption{Path Typing}
\end{figure}

\begin{lem}[Path Type Uniqueness]
  $\PType{\Gamma}{x}{p}{\tau}\ \land\ \PType{\Gamma}{x}{p}{\tau'}\ \Rightarrow\ \tau = \tau'$.
\end{lem}

\begin{proof}
  TODO. Probably just straightforward induction.
\end{proof}

\begin{lem}[Path Type Preservation]
  $\HWF{H}{\Sigma}{\Psi}\ \land\ \SWF{\Gamma}{V}{\Sigma}\ \land\ \\
   \PType{\Gamma}{x}{p}{\tau}\ \land\ \PEval{V}{H}{x}{p}{\alpha}{r}\ \Rightarrow\
   \ARType{\Sigma}{\Psi}{\alpha}{r}{\tau}$.
\end{lem}

\begin{proof}
  Induction on $\PEval{V}{H}{x}{p}{\alpha}{r}$.

  \textsc{Case PE-BASE}:
    Then $p = \Base$, $r = \Base$, and $V(x) = \alpha$.

    By inversion via \textsc{PT-BASE} on $\PType{\Gamma}{x}{\Base}{\tau}$, we have $\Gamma(x)=\tau$.

    We know $\Gamma(x) = \Sigma(V(x))$ from $\SWF{\Gamma}{V}{\Sigma}$.
    Thus, $\tau = \Sigma(\alpha)$.

    By applying \textsc{RT-BASE}, we have $\ARType{\Sigma}{\Psi}{\alpha}{\Base}{\tau}$.

  \textsc{Case PE-DEOWN}:
    Then $p = \Deref{p'}$, $\PEval{V}{H}{x}{p'}{\alpha'}{r'}$,
    and $\Read{H}{\alpha'}{r'}{\Slot{\OwnVal{\alpha}{r}}}$.

    By inversion, there are two ways $\PType{\Gamma}{x}{\Deref{p'}}{\tau}$ could have been built:
    \textsc{PT-DEOWN} or \textsc{PT-DEREF}. The \textsc{PT-DEREF} case will turn out to be
    impossible because it implies
    $\RTType{\Sigma}{\Psi}{\Slot{\OwnVal{\alpha}{r}}}{\Ref{\ell}{q}{\tau}}$, which cannot be
    derived. The proof for the \textsc{PT-DEOWN} case follows. The \textsc{PT-DEREF} case would
    be handled similarly upto the contradiction, which I will point out.
    Inversion via \textsc{PT-DEOWN} implies $\PType{\Gamma}{x}{p'}{\Own{\tau}}$.

    By induction with $\PType{\Gamma}{x}{p'}{\Own{\tau}}$ and $\PEval{V}{H}{x}{p'}{\alpha'}{r'}$,
    we have $\ARType{\Sigma}{\Psi}{\alpha'}{r'}{\Own{\tau}}$.

    By Read Safety with $\ARType{\Sigma}{\Psi}{\alpha'}{r'}{\Own{\tau}}$, we have
    $\exists l.\ \Read{H}{\alpha'}{r'}{l}\ \land\ \RTType{\Sigma}{\Psi}{l}{\Own{\tau}}$.

    By Read Uniqueness with $\Read{H}{\alpha'}{r'}{\Slot{\OwnVal{\alpha}{r}}}$ and
    $\Read{H}{\alpha'}{r'}{l}$, we have $l = \Slot{\OwnVal{\alpha}{r}}$.

    (At this point in the \textsc{PT-DEREF} case we have 
    $\RTType{\Sigma}{\Psi}{\Slot{\OwnVal{\alpha}{r}}}{\Ref{\ell}{q}{\tau}}$
    and the contradiction appears.)

    By inversion via \textsc{LT-SLOT} on
    $\RTType{\Sigma}{\Psi}{\Slot{\OwnVal{\alpha}{r}}}{\Own{\tau}}$, we have
    $\RTType{\Sigma}{\Psi}{\OwnVal{\alpha}{r}}{\Own{\tau}}$.

    By inversion via \textsc{ST-OWN} on
    $\RTType{\Sigma}{\Psi}{\OwnVal{\alpha}{r}}{\Own{\tau}}$, we have
    $\ARType{\Sigma}{\Psi}{\alpha}{r}{\tau}$.

    \textsc{Case PE-DEREF}: 
      This is similar to the \textsc{PE-DEOWN} case except the roles of
      \textsc{PT-DEOWN} and \textsc{PT-DEREF} are reversed.

  \textsc{Case PE-PROJ}:
    Then $p = \Proj{p'}{n}{i}$, $r = \Proj{r'}{n}{i}$, and $\PEval{V}{H}{x}{p'}{\alpha}{r'}$.

    By inversion via \textsc{PT-PROJ} on $\PType{\Gamma}{x}{\Proj{p'}{n}{i}}{\tau}$,
    we have $\tau = \tau_i$ and $\PType{\Gamma}{x}{p'}{\Rec{\tau_i}{n}}$.

    By induction with $\PType{\Gamma}{x}{p'}{\Rec{\tau_i}{n}}$
    and $\PEval{V}{H}{x}{p'}{\alpha}{r'}$,
    we have $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Rec{\tau_i}{n}}$.

    By applying \textsc{RT-PROJ} to $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Rec{\tau_i}{n}}$,
    we have $\ARType{\Sigma}{\Psi}{\alpha}{\Proj{r'}{n}{i}}{\tau_i}$.

  \textsc{Case PE-UNROLL}:
    Then $p = \Unroll{\Fix{X}{\tau'}}{p'}$, $r = \Unroll{\Fix{X}{\tau'}}{r'}$,
    and $\PEval{V}{H}{x}{p'}{\alpha}{r'}$.

    By inversion via \textsc{PT-UNROLL} on $\PType{\Gamma}{x}{\Unroll{\Fix{X}{\tau'}}{p'}}{\tau}$,
    we have $\tau = \Subst{X}{\Fix{X}{\tau'}}{\tau'}$ and $\PType{\Gamma}{x}{p'}{\Fix{X}{\tau'}}$.

    By induction with $\PType{\Gamma}{x}{p'}{\Fix{X}{\tau'}}$ and $\PEval{V}{H}{x}{p'}{\alpha}{r'}$,
    we have $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Fix{X}{\tau'}}$.

    By applying \textsc{RT-UNROLL} to $\ARType{\Sigma}{\Psi}{\alpha}{r'}{\Fix{X}{\tau'}}$,
    we have
    $\ARType{\Sigma}{\Psi}{\alpha}{\Unroll{\Fix{X}{\tau'}}{r'}}{\Subst{X}{\Fix{X}{\tau'}}{\tau'}}$.
\end{proof}

\begin{lem}[Shallow Type Preservation]
  $\YWF{\Upsilon}{\Gamma}\ \land\ \PType{\Gamma}{x}{p}{\tau}\ \land\
   \Shallow{\Upsilon}{x}{p}{\sigma}\ \Rightarrow\ \Type{\Upsilon}{\sigma}{\tau}$.
\end{lem}

\begin{proof}
  TODO.
\end{proof}

\begin{lem}[Path Shape Preservation]
  $\Type{V}{H}{\Upsilon}\ \land\ \Shallow{\Upsilon}{x}{p}{\sigma}\ \land\
   \PEval{V}{H}{x}{p}{\alpha}{r}\ \land\ \Read{H}{\alpha}{r}{l}\ \Rightarrow\
   \Type{H}{l}{\sigma}$.
\end{lem}

\begin{proof}
  TODO.
\end{proof}

\begin{lem}[Path Progress]
  $\HWF{H}{\Sigma}{\Psi}\ \land\ \SWF{\Gamma}{V}{\Sigma}\ \land\
   \YWF{\Upsilon}{\Gamma}\ \land\ \\ \Type{V}{H}{\Upsilon}\ \land\ 
   \PType{\Gamma}{x}{p}{\tau}\ \land\ \Shallow{\Upsilon}{x}{p}{\sigma}\ 
   \Rightarrow\ \exists \alpha, r.\ \PEval{V}{H}{x}{p}{\alpha}{r}$.
\end{lem}

\begin{proof}
  Induction on $\PType{\Gamma}{x}{p}{\tau}$.

  \textsc{Case PT-BASE}: 
    Then $p = \Base$ and $\Gamma(x) = \tau$.

    From $\SWF{\Gamma}{V}{\Sigma}$, we have $\Gamma(x) = \Sigma(V(x))$.
    Ergo, $\exists \alpha.\ V(x) = \alpha$.

    By \textsc{PE-BASE}, we have $\PEval{V}{H}{x}{\Base}{\alpha}{\Base}$.

  \textsc{Case PT-DEOWN}:
    Then $p = \Deref{p'}$ and $\PType{\Gamma}{x}{p'}{\Own{\tau}}$.

    By inversion, $\Shallow{\Upsilon}{x}{\Deref{p'}}{\sigma}$ was built by either
    \textsc{SI-DEOWN} or \textsc{SI-DEREF}. However, the \textsc{SI-DEREF} case is
    impossible as Shallow Type Preservation would imply
    $\PType{\Gamma}{x}{p'}{\Ref{\ell}{q}{\tau}}$, which is a contradiction due to
    $\PType{\Gamma}{x}{p'}{\Own{\tau}}$ and Path Type Uniqueness.
    Thus the only case is \textsc{SI-DEOWN}, which implies
    $\Shallow{\Upsilon}{x}{p'}{\Hole{\Own{\sigma}}}$.

    By induction with $\PType{\Gamma}{x}{p'}{\Own{\tau}}$ and
    $\Shallow{\Upsilon}{x}{p'}{\Hole{\Own{\sigma}}}$, we have
    $\exists \alpha, r.\ \PEval{V}{H}{x}{p'}{\alpha}{r}$.

    By Path Type Preservation with $\PType{\Gamma}{x}{p'}{\Own{\tau}}$ and
    $\PEval{V}{H}{x}{p'}{\alpha}{r}$, we have $\ARType{\Sigma}{\Psi}{\alpha}{r}{\Own{\tau}}$.

    By Read Safety with $\ARType{\Sigma}{\Psi}{\alpha}{r}{\Own{\tau}}$, we have
    $\exists l.\ \Read{H}{\alpha}{r}{l}\ \land\ \RTType{\Sigma}{\Psi}{l}{\Own{\tau}}$.

    By inversion via \textsc{LT-SLOT} on $\RTType{\Sigma}{\Psi}{l}{\Own{\tau}}$,
    we have $l = \Slot{s}$ and $\RTType{\Sigma}{\Psi}{s}{\Own{\tau}}$.

    By Path Shape Preservation with $\Shallow{\Upsilon}{x}{p'}{\Hole{\Own{\sigma}}}$,
    $\PEval{V}{H}{x}{p'}{\alpha}{r}$, and $\Read{H}{\alpha}{r}{\Slot{s}}$, we have
    $\Type{H}{\Slot{s}}{\Hole{\Own{\sigma}}}$.

    By inversion via \textsc{LS-OWN}, we have: $s =\ \OwnVal{\alpha'}{r'}$ and
    $\Read{H}{\alpha'}{r'}{l'}$.

    By applying \textsc{PE-DEOWN} to $\PEval{V}{H}{x}{p'}{\alpha}{r}$ and
    $\Read{H}{\alpha}{r}{\Slot{\OwnVal{\alpha'}{r'}}}$, we have
    $\PEval{V}{H}{x}{\Deref{p'}}{\alpha'}{r'}$.

  \textsc{Case PT-DEREF}:
    Then $p = \Deref{p'}$ and $\PType{\Gamma}{x}{p'}{\Ref{\ell}{q}{\tau}}$.

    By inversion, $\Shallow{\Upsilon}{x}{\Deref{p'}}{\sigma}$ was built by either
    \textsc{SI-DEOWN} or \textsc{SI-DEREF}. However, the \textsc{SI-DEOWN} case is
    impossible as Shallow Type Preservation would imply
    $\PType{\Gamma}{x}{p'}{\Own{\tau}}$, which is a contradiction due to
    $\PType{\Gamma}{x}{p'}{\Ref{\ell}{q}{\tau}}$ and Path Type Uniqueness.
    Thus the only case is \textsc{SI-DEREF}, which implies
    $\Shallow{\Upsilon}{x}{p'}{\Hole{\RefVal{q}{\tau}}}$.

    By induction with $\PType{\Gamma}{x}{p'}{\Ref{\ell}{q}{\tau}}$ and
    $\Shallow{\Upsilon}{x}{p'}{\Hole{\RefVal{q}{\tau}}}$, we have
    $\exists \alpha, r.\ \PEval{V}{H}{x}{p'}{\alpha}{r}$.

    By Path Type Preservation with $\PType{\Gamma}{x}{p'}{\Ref{\ell}{q}{\tau}}$ and
    $\PEval{V}{H}{x}{p'}{\alpha}{r}$, we have
    $\ARType{\Sigma}{\Psi}{\alpha}{r}{\Ref{\ell}{q}{\tau}}$.

    By Read Safety with $\ARType{\Sigma}{\Psi}{\alpha}{r}{\Ref{\ell}{q}{\tau}}$, we have
    $\exists l.\ \Read{H}{\alpha}{r}{l}\ \land\ \RTType{\Sigma}{\Psi}{l}{\Ref{\ell}{q}{\tau}}$.

    By inversion via \textsc{LT-SLOT} on $\RTType{\Sigma}{\Psi}{l}{\Ref{\ell}{q}{\tau}}$,
    we have $l = \Slot{s}$ and $\RTType{\Sigma}{\Psi}{s}{\Ref{\ell}{q}{\tau}}$.

    By Path Shape Preservation with $\Shallow{\Upsilon}{x}{p'}{\Hole{\RefVal{q}{\tau}}}$,
    $\PEval{V}{H}{x}{p'}{\alpha}{r}$, and $\Read{H}{\alpha}{r}{\Slot{s}}$, we have
    $\Type{H}{\Slot{s}}{\Hole{\RefVal{q}{\tau}}}$.

    By inversion via \textsc{LS-REF}, we have: $s = \Ref{q}{\alpha'}{r'}$ and
    $\Read{H}{\alpha'}{r'}{l'}$.

    By applying \textsc{PE-DEREF} to $\PEval{V}{H}{x}{p'}{\alpha}{r}$ and
    $\Read{H}{\alpha}{r}{\Slot{\Ref{q}{\alpha'}{r'}}}$, we have
    $\PEval{V}{H}{x}{\Deref{p'}}{\alpha'}{r'}$.

  \textsc{Case PT-PROJ}:
    Then $p = \Proj{p'}{n}{i}$, $\tau = \tau_i$, and $\PType{\Gamma}{x}{p'}{\Rec{\tau_i}{n}}$.

    By inversion via \textsc{SI-PROJ} on $\Shallow{\Upsilon}{x}{\Proj{p'}{n}{i}}{\sigma}$,
    we have $\sigma = \sigma_i$ and $\Shallow{\Upsilon}{x}{p'}{\Rec{\sigma_i}{n}}$.

    By induction with $\PType{\Gamma}{x}{p'}{\Rec{\tau_i}{n}}$
    and $\Shallow{\Upsilon}{x}{p'}{\Rec{\sigma_i}{n}}$,
    we have $\exists \alpha, r.\ \PEval{V}{H}{x}{p'}{\alpha}{r}$.

    By applying \textsc{PE-PROJ} to $\PEval{V}{H}{x}{p'}{\alpha}{r}$,
    we have $\PEval{V}{H}{x}{\Proj{p'}{n}{i}}{\alpha}{\Proj{r}{n}{i}}$.

  \textsc{Case PT-UNROLL}:
    Then $p = \Unroll{\Fix{X}{\tau'}}{p'}$, $\tau = \Subst{X}{\Fix{X}{\tau'}}{\tau'}$,
    and $\PType{\Gamma}{x}{p'}{\Fix{X}{\tau'}}$.

    By inversion via \textsc{SI-UNROLL} on
    $\Shallow{\Upsilon}{x}{\Unroll{\Fix{X}{\tau'}}{p'}}{\sigma}$, we have
    $\Shallow{\Upsilon}{x}{p'}{\Roll{\Fix{X}{\tau'}}{\sigma}}$.

    By induction with $\PType{\Gamma}{x}{p'}{\Fix{X}{\tau'}}$
    and $\Shallow{\Upsilon}{x}{p'}{\Roll{\Fix{X}{\tau'}}{\sigma}}$,
    we have $\exists \alpha, r.\ \PEval{V}{H}{x}{p'}{\alpha}{r}$.

    By applying \textsc{PE-UNROLL} to $\PEval{V}{H}{x}{p'}{\alpha}{r}$,
    we have $\PEval{V}{H}{x}{\Unroll{\Fix{X}{\tau'}}{p'}}{\alpha}{\Unroll{\Fix{X}{\tau'}}{r}}$.
\end{proof}

\end{document}
